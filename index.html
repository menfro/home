מעולה - אז אנחנו על **תיקון לוגיקה פיננסית**.

להלן רשימת תיקונים “קשיחים” (לא קוסמטיקה) שממש משנים את נכונות המודל, עם הצעה איך לתקן בקוד.

## 1) הבאג הכי גדול: מסלול שכירות - התיק מתחיל מההון העצמי גם אם הוא הושקע בדירה

כרגע אתה עושה:

```js
let investmentPortfolio = inputs.equity; 
let totalInvestedPrincipal = inputs.equity;
```

אבל במסלול קנייה אתה בעצם משתמש ב-`equityUsed` (ולא פעם בכולו), ולכן ההשוואה לא הוגנת: השוכר “שומר” את ההון העצמי להשקעות גם אם בקנייה הוא נעלם לדירה ולהוצאות.

תיקון מומלץ - לקבוע “כמה כסף נשאר להשקיע” בשני המסלולים באותה נקודת זמן:

* **במסלול קנייה**: נשאר להשקיע `remainingLiquidEquity`
* **במסלול שכירות**: נשאר להשקיע `equity + liquidPortfolio` (או רק `equity` אם אתה מפריד תיקים)

הבעיה השניה: בכלל יש לך גם `liquidPortfolio` בפרופיל, והוא כמעט לא נכנס למנוע הראשי.

### תיקון קונסיסטנטי:

להוסיף `startingLiquid` שמייצג את כל הנזילות שאינה “נעולה” בעסקה:

```js
const loanDetails = calculateLoanDetails(inputs);
const startingLiquidForBuy = (inputs.liquidPortfolio || 0) + loanDetails.remainingLiquidEquity;
const startingLiquidForRent = (inputs.liquidPortfolio || 0) + (inputs.equity || 0);

// במסלול שכירות
let investmentPortfolio = startingLiquidForRent;
let totalInvestedPrincipal = startingLiquidForRent;

// במסלול קנייה - תיק נזיל צדדי (במקום buyerSidePortfolio מחושב רק בסוף)
let buyerLiquidPortfolio = startingLiquidForBuy;
```

ואז בתוך הלולאה:

* במסלול שכירות: כל חודש מוסיפים/מורידים את `difference` לתיק
* במסלול קנייה: אין “difference” לתיק השכירות (כי זו חלופה), אבל אפשר להשאיר את `buyerLiquidPortfolio` פשוט גדל בתשואת שוק ההון (או להוסיף אליו רק עודפים אם אתה רוצה מודל מתקדם)

כרגע אתה מערבב בין “תיק של שוכר” לבין “תיק צדדי של קונה” בצורה לא עקבית.

---

## 2) Double counting של הוצאות דיור בתחזוקה: אתה מוסיף תחזוקה בכל חודש, אבל “החזר חודשי” בכרטיס מסלול קנייה לא כולל אותה

בכרטיסים אתה מציג:

* `monthlyMortgage` כהחזר חודשי
  אבל בפועל בקנייה התזרים הוא:
* `monthlyMortgage + monthlyMaintenance`

זה גורם לאנשים לקרוא “החזר חודשי” ולחשוב שזה המחיר החודשי, וזה לא.

תיקון:

* להציג גם `תחזוקה חודשית נוכחית` ליד ההחזר
* או להוסיף `monthlyHousingBuyNow = monthlyMortgage + maintMonthlyNow` ולהציג אותו כ-“דיור חודשי” ולא “החזר משכנתא”.

---

## 3) “הוצאות מכירה/שבח” - כרגע זה רק הוצאות מכירה, אין כאן מס שבח אמיתי

אתה מחשב:

```js
const sellExpenses = currentPropVal * (inputs.sellingExpensesRate / 100);
```

ומכנה את זה גם “שבח”. זה מטעה מבחינה פיננסית.

אם אתה לא רוצה להיכנס למס שבח אמיתי (שמצריך בסיס עלות, פטורים, דירה יחידה, הצמדה וכו’), אז הפתרון הנכון הוא:

* לשנות label ל-**"הוצאות מכירה"**
* ואם רוצים מס שבח - להוסיף שדה נפרד: `capitalGainsOnPropertyTaxRate` ולחשב בקירוב:

  * רווח = (שווי עתידי - מחיר קניה - הוצאות רכישה - הוצאות שיפור)
  * מס = max(0, רווח) * שיעור

בלי זה - אל תקרא לזה שבח.

---

## 4) “מס רווחי הון” על התיק - כרגע אתה ממסה את כל הרווח כאילו מממשים בסוף, אבל אתה גם משתמש בתיק לתזרים במהלך הדרך

במסלול שכירות אתה עושה:

* התיק גדל תשואה חודשית
* ואז מוסיף/מוריד `difference` (הפרש תזרים)
* ואם התיק מגיע ל-0 אתה מקבע ל-0

אבל מיסוי:

```js
const portfolioGain = Math.max(0, investmentPortfolio - totalInvestedPrincipal);
const capitalGainsTax = portfolioGain * (inputs.capitalGainsTax / 100);
const rentNetWorth = investmentPortfolio - capitalGainsTax;
```

הבעיה: אם במהלך הדרך משכת כסף (difference שלילי) זה שקול למכירה חלקית, ואז מס אמור להתרחש לאורך התקופה, לא רק בסוף. המודל הנוכחי מניח “אין מס עד סוף”, ואז מס מלא בסוף - זה קירוב, אבל צריך להיות מוגדר ככזה.

תיקון מינימלי (בלי סימולציית realized gains):

* לשנות טקסט במסך ל-“מס משוער אם מממשים בסוף התקופה”
* ולהוסיף toggle: “מיסוי שוטף על משיכות” (אופציונלי)

---

## 5) break-even ו-yearRecoveredEntryCosts: ההגדרה שלך לא נכונה מבחינה כלכלית

### yearRecoveredEntryCosts

כרגע:

```js
const initialEquityUsed = inputs.equity - remainingLiquidEquity;
if (yearRecoveredEntryCosts === null && netWorthBuy > initialEquityUsed) yearRecoveredEntryCosts = year;
```

אבל `netWorthBuy` כולל גם את התיק הצדדי (buyerLiquid) ובנוסף כולל את ההון העצמי שנמצא כבר בתוך הבית - אז אתה בעצם בודק “מתי אני מעל הכסף ששמתי”, וזה כמעט תמיד יקרה מהר מדי/בצורה לא מייצגת.

מה שאתה כנראה רוצה למדוד:

* מתי **רווח ההון על הדירה** מכסה את **עלויות הכניסה** (מס רכישה + עו"ד + תיווך וכו’)
  כלומר:

```js
const entryCosts = purchaseTaxAmount + buyingMiscAmount + brokerageAmount;
const propGain = currentPropVal - inputs.propertyPrice; // או בניכוי שיפוץ אם יש
if (yearRecoveredEntryCosts === null && propGain > entryCosts) yearRecoveredEntryCosts = year;
```

זה מדד הרבה יותר אמיתי ל-“נקודת אל-חזור”.

### break-evenYear

אתה מחשב נכון על בסיס `netWorthBuy >= netWorthRent`, אבל רק אם מסלול השכירות ומסלול הקנייה מתחילים מאותה נזילות (סעיף 1). אחרת break-even יוצא עקום.

---

## 6) תחזוקה מחושבת על שווי נכס עולה - סבבה, אבל חסר “שיפוץ/CapEx” חד-פעמי

בישראל זה נפוץ שיהיה:

* שיפוץ / התאמות / ריהוט
* לפעמים גם עלויות מעבר

אם אתה כבר בתוך מנוע רציני, שווה להוסיף:

* `initialRenovationAmount`
  ואז:
* להוסיף אותו לעלות רכישה (מקטין נזילות/מגדיל הלוואה אם ממומן)
* או להוסיף אותו ל-“entryCosts”

---

## 7) עקביות של “liquidPortfolio” - כרגע הוא כמעט לא משפיע על השורה התחתונה

יש לך `liquidPortfolio` בפרופיל, והוא משפיע על DTI וחוסן - אבל לא על תוצאות buy vs rent.

אם הכוונה שזה “כסף שלא נוגע בעסקה” - אז הוא חייב להיכנס לשני המסלולים באותה צורה (למשל כתיק נזיל חיצוני שמייצר תשואה).

---

# מה אני מציע כסט שינויים מינימלי (שיעשה את המודל נכון)

1. להכניס את `liquidPortfolio` למנוע הראשי וליצור:

   * `startingLiquidForRent`
   * `startingLiquidForBuy`
2. לשנות את מסלול השכירות כך שהתיק מתחיל מהנזילות האמיתית (ולא מהון עצמי שמשמש לקנייה).
3. לתקן `yearRecoveredEntryCosts` לפי רווח נכס מול עלויות כניסה.
4. לתקן labels: “הוצאות מכירה” במקום “שבח” (אלא אם מוסיפים מס שבח).
5. להציג “דיור חודשי” (משכנתא + תחזוקה) ולא רק משכנתא.

---

אם תדביק לי את ה-`calculateResults` המעודכן שאתה רוצה שאני אשנה (או תגיד “תן לי patch מלא”), אני יכול להחזיר לך **קטע קוד מלא להחלפה** של הפונקציה + השינויים הקטנים ב-UI שצריך כדי שהכל יוצג נכון.
