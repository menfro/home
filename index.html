import React, { useState, useMemo, useEffect } from 'react';
import { 
  Calculator, 
  Home, 
  TrendingUp, 
  PieChart, 
  Info,
  CheckCircle2,
  Building,
  ArrowRightLeft,
  Briefcase,
  DollarSign,
  Scale,
  Settings,
  AlertTriangle,
  RefreshCcw,
  Edit3,
  Link,
  Save,
  RotateCcw,
  Plus,
  Trash2,
  X
} from 'lucide-react';

// --- Constants & Defaults ---
const DEFAULTS = {
  // Basic
  propertyPrice: 5500000,
  equity: 3500000, 
  currentRent: 9000,
  analysisYears: 10, 
  mortgageTerm: 25, 
  
  // Rates
  marketReturn: 7.0, 
  propertyAppreciation: 3.0, 
  rentInflation: 3.0,
  mortgageInterest: 4.8, 
  
  // Advanced / Taxes / Costs
  maintenanceCost: 0.5, 
  purchaseTaxRate: 0.0, // Taxes on entry
  buyingMiscRate: 0.5, // Legal, Appraisal etc. (approx 0.5%)
  brokerageRate: 1.5, // Brokerage fee (before VAT)
  sellingExpensesRate: 1.5, // Brokerage, Legal on exit
  capitalGainsTax: 25.0, 
  vatRate: 17.0, // Current VAT in Israel
};

// Colors for dynamic tracks
const TRACK_COLORS = ['bg-blue-500', 'bg-purple-500', 'bg-orange-500', 'bg-green-500', 'bg-pink-500', 'bg-teal-500'];

const DEFAULT_MIXES = [
    { 
        id: 1,
        name: "סולידי ויציב", 
        risk: "נמוך",
        desc: "החזר קבוע, חשיפה מינימלית לשינויים.",
        tracks: [
            { id: 't1', name: 'פריים', percent: 33, rate: 6.0, color: 'bg-blue-500' },
            { id: 't2', name: 'קל"צ', percent: 67, rate: 4.8, color: 'bg-purple-500' }
        ]
    },
    { 
        id: 2,
        name: "המסלול המאוזן", 
        risk: "בינוני",
        desc: "שילוב בין יציבות לבין ניצול ריביות משתנות.",
        tracks: [
            { id: 't1', name: 'פריים', percent: 33, rate: 6.0, color: 'bg-blue-500' },
            { id: 't2', name: 'קל"צ', percent: 34, rate: 4.8, color: 'bg-purple-500' },
            { id: 't3', name: 'משתנה', percent: 33, rate: 3.5, color: 'bg-orange-500' }
        ]
    },
    { 
        id: 3,
        name: "צמוד מדד (זול התחלתית)", 
        risk: "גבוה",
        desc: "החזר התחלתי נמוך, מסוכן בעליית אינפלציה.",
        tracks: [
            { id: 't1', name: 'פריים', percent: 33, rate: 6.0, color: 'bg-blue-500' },
            { id: 't2', name: 'קל"צ', percent: 17, rate: 4.8, color: 'bg-purple-500' },
            { id: 't3', name: 'משתנה', percent: 50, rate: 3.2, color: 'bg-orange-500' }
        ]
    }
];

// --- Helper Functions ---

const calculatePMT = (principal, annualRate, years) => {
  if (principal <= 0) return 0;
  if (annualRate === 0) return principal / (years * 12);
  const monthlyRate = annualRate / 100 / 12;
  const numberOfPayments = years * 12;
  return (principal * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -numberOfPayments));
};

const calculateRemainingBalance = (principal, annualRate, totalYears, monthsPassed) => {
    if (principal <= 0) return 0;
    const totalPayments = totalYears * 12;
    if (monthsPassed >= totalPayments) return 0;

    if (annualRate === 0) {
        const paid = (principal / totalPayments) * monthsPassed;
        return Math.max(0, principal - paid);
    }
    const monthlyRate = annualRate / 100 / 12;
    return principal * ( (Math.pow(1 + monthlyRate, totalPayments) - Math.pow(1 + monthlyRate, monthsPassed)) / (Math.pow(1 + monthlyRate, totalPayments) - 1) );
};

const formatILS = (num) => {
  if (isNaN(num)) return "₪0";
  return new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS', maximumFractionDigits: 0 }).format(num);
};

// Centralized Loan Logic (Sources & Uses)
const calculateLoanDetails = (inputs) => {
    const purchaseTaxAmount = inputs.propertyPrice * (inputs.purchaseTaxRate / 100);
    const buyingMiscAmount = inputs.propertyPrice * (inputs.buyingMiscRate / 100);
    
    // Brokerage Calculation: Price * % * (1 + VAT)
    const brokerageAmount = inputs.propertyPrice * (inputs.brokerageRate / 100) * (1 + inputs.vatRate / 100);
    
    const totalAcquisitionCost = inputs.propertyPrice + purchaseTaxAmount + buyingMiscAmount + brokerageAmount;
    
    // Equity covers as much as possible of the TOTAL cost
    const equityUsed = Math.min(inputs.equity, totalAcquisitionCost);
    
    // Loan covers the rest
    const loanAmount = Math.max(0, totalAcquisitionCost - equityUsed);
    
    // LTV Logic
    const equityAvailableForProperty = Math.max(0, equityUsed - (purchaseTaxAmount + buyingMiscAmount + brokerageAmount));
    const loanUsedForProperty = Math.max(0, inputs.propertyPrice - equityAvailableForProperty);

    // Remaining liquid equity
    const remainingLiquidEquity = Math.max(0, inputs.equity - totalAcquisitionCost);

    return {
        purchaseTaxAmount,
        buyingMiscAmount,
        brokerageAmount,
        totalAcquisitionCost,
        equityUsed,
        loanAmount,
        loanUsedForProperty,
        remainingLiquidEquity
    };
};

// --- Sub-Components ---

const Tooltip = ({ text }) => (
  <div className="group relative inline-block ml-2 cursor-help text-gray-400 hover:text-blue-500">
    <Info size={16} />
    <div className="opacity-0 w-48 bg-gray-800 text-white text-xs rounded p-2 absolute z-10 bottom-full left-1/2 transform -translate-x-1/2 mb-2 group-hover:opacity-100 transition-opacity pointer-events-none shadow-lg border border-gray-700 z-50 pointer-events-none">
      {text}
    </div>
  </div>
);

const InputField = ({
  label,
  value,
  onChange,
  suffix = "",
  tooltip = "",
  disabled = false,
  className = "",
  type = "text",
  inputMode = "decimal",
}) => {
  const [isFocused, setIsFocused] = useState(false);
  const [inputValue, setInputValue] = useState(value ? value.toString() : '');

  useEffect(() => {
    if (!isFocused && value !== undefined && value !== null) {
      setInputValue(Number(value).toLocaleString());
    }
  }, [value, isFocused]);

  const handleFocus = () => {
    setIsFocused(true);
    setInputValue(value !== undefined && value !== null ? value.toString() : '');
  };

  const handleBlur = () => {
    setIsFocused(false);
    if (inputValue !== '' && inputValue !== '-') {
         setInputValue(value !== undefined && value !== null ? Number(value).toLocaleString() : '');
    }
  };

  const handleChange = (e) => {
    const rawInput = e.target.value;
    setInputValue(rawInput); 
    const cleanNumber = rawInput.replace(/,/g, '');
    if (cleanNumber === '-') return; 
    
    if (cleanNumber === '') {
       onChange(0);
    } else if (!isNaN(cleanNumber)) {
       onChange(parseFloat(cleanNumber));
    }
  };

  return (
    <div className={`mb-4 ${className}`}>
      <label className="block text-sm font-medium text-gray-700 mb-1 flex items-center">
        {label}
        {tooltip && <Tooltip text={tooltip} />}
      </label>
      <div className="relative rounded-md shadow-sm">
        <input
          type={type}
          inputMode={inputMode}
          value={inputValue}
          onChange={handleChange}
          onFocus={handleFocus}
          onBlur={handleBlur}
          disabled={disabled}
          className={`block w-full p-3 sm:p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-base sm:text-sm ${
            suffix ? "pl-10" : ""
          } ${disabled ? "bg-gray-100 text-gray-500 cursor-not-allowed" : ""}`}
        />
        {suffix && (
          <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span className="text-gray-500 sm:text-sm">{suffix}</span>
          </div>
        )}
      </div>
    </div>
  );
};

const ResultCard = ({ title, value, subtext, icon: Icon, isWinner, bottomContent, headerColor = "text-gray-700", alertContent }) => (
  <div className={`p-6 rounded-xl border-2 transition-all flex flex-col justify-between h-full ${isWinner ? 'border-green-500 bg-green-50 shadow-lg' : 'border-gray-200 bg-white'}`}>
    <div>
        <div className="flex items-center justify-between mb-2">
        <h3 className={`font-bold ${headerColor}`}>{title}</h3>
        <Icon className={isWinner ? 'text-green-600' : 'text-gray-400'} size={24} />
        </div>
        <div className="text-3xl font-bold text-gray-900 mb-1">{value}</div>
        <p className="text-sm text-gray-500 mb-3">{subtext}</p>
        
        {alertContent && (
            <div className="mb-3 text-xs bg-red-50 border border-red-100 text-red-600 p-2 rounded flex items-start">
                <AlertTriangle size={14} className="mr-1 ml-1 flex-shrink-0 mt-0.5"/>
                {alertContent}
            </div>
        )}
    </div>
    
    <div className="mt-auto">
        {bottomContent}
        {isWinner && (
            <div className="mt-4 text-green-700 text-sm font-bold flex items-center bg-green-100 p-2 rounded">
                <CheckCircle2 size={16} className="mr-1 ml-1" /> המסלול המשתלם כלכלית
            </div>
        )}
    </div>
  </div>
);

// Improved MiniInput: Label on top, full width capable
const MiniInput = ({ value, onChange, label, suffix = "", className = "" }) => {
    const [isFocused, setIsFocused] = useState(false);
    const [localVal, setLocalVal] = useState(value !== undefined ? value.toString() : '');

    useEffect(() => {
        if (!isFocused && value !== undefined) {
            setLocalVal(Number(value).toLocaleString());
        }
    }, [value, isFocused]);

    const handleFocus = () => {
        setIsFocused(true);
        setLocalVal(value !== undefined ? value.toString() : '');
    };

    const handleBlur = () => {
        setIsFocused(false);
        if (localVal !== '' && localVal !== '-') {
             setLocalVal(Number(value).toLocaleString());
        }
    };

    const handleChange = (e) => {
        const val = e.target.value;
        setLocalVal(val);
        const cleanNumber = val.replace(/,/g, '');
        
        if (cleanNumber !== '' && !isNaN(cleanNumber)) {
            let num = parseFloat(cleanNumber);
            if (num < 0) num = 0; 
            if (suffix === '%' && num > 100) num = 100;
            onChange(num);
        } else if (cleanNumber === '') {
            onChange(0);
        }
    };

    return (
        <div className="flex flex-col items-center w-full">
            {label && <span className="text-[10px] text-gray-400 mb-0.5">{label}</span>}
            <div className="relative w-full">
                <input 
                    type="text"
                    inputMode="decimal"
                    value={localVal}
                    onChange={handleChange}
                    onFocus={handleFocus}
                    onBlur={handleBlur}
                    className={`w-full h-9 p-1 ${suffix ? 'pl-5' : 'pl-1'} text-center text-sm border border-gray-200 rounded bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none ${className}`}
                />
                {suffix && <span className="absolute left-1.5 top-2.5 text-xs text-gray-400 pointer-events-none">{suffix}</span>}
            </div>
        </div>
    );
};

// --- Main Application ---

export default function App() {
  const [activeTab, setActiveTab] = useState(1);
  const [showAdvanced, setShowAdvanced] = useState(false);
  const [viewMode, setViewMode] = useState('netWorth'); 
  const [inputs, setInputs] = useState(DEFAULTS);
  
  // --- MIX TAB STATE ---
  const [userMixes, setUserMixes] = useState(DEFAULT_MIXES);
  const [mixTabLoanAmount, setMixTabLoanAmount] = useState(0); 
  const [mixTabTerm, setMixTabTerm] = useState(25);
  const [isMixCustomized, setIsMixCustomized] = useState(false);

  // --- MEMOIZED CALCULATIONS ---
  const loanDetails = useMemo(() => calculateLoanDetails(inputs), [inputs]);

  useEffect(() => {
      if (!isMixCustomized) {
          setMixTabLoanAmount(loanDetails.loanAmount);
          setMixTabTerm(inputs.mortgageTerm);
      }
  }, [loanDetails.loanAmount, inputs.mortgageTerm, isMixCustomized]);

  const results = useMemo(() => {
    const { 
        loanAmount, 
        purchaseTaxAmount, 
        buyingMiscAmount,
        brokerageAmount,
        remainingLiquidEquity
    } = loanDetails;
    
    const monthlyMortgage = calculatePMT(loanAmount, inputs.mortgageInterest, inputs.mortgageTerm);
    
    // Rent Scenario
    let investmentPortfolio = inputs.equity; 
    let totalInvestedPrincipal = inputs.equity; 
    let currentMonthlyRent = inputs.currentRent;
    
    let totalRentPaid = 0;
    let totalMortgagePaid = 0;
    let totalMaintenancePaid = 0;
    let portfolioHitZeroMonth = null;

    const totalMonths = inputs.analysisYears * 12;

    for (let i = 1; i <= totalMonths; i++) {
      totalRentPaid += currentMonthlyRent;
      
      let currentMonthMortgage = (i <= inputs.mortgageTerm * 12) ? monthlyMortgage : 0;
      totalMortgagePaid += currentMonthMortgage;

      const currentPropVal = inputs.propertyPrice * Math.pow(1 + inputs.propertyAppreciation/100, (i-1)/12);
      const monthlyMaintenance = currentPropVal * (inputs.maintenanceCost / 100 / 12);
      totalMaintenancePaid += monthlyMaintenance;

      const buyerMonthlyOutflow = currentMonthMortgage + monthlyMaintenance;
      const renterMonthlyOutflow = currentMonthlyRent;
      const difference = buyerMonthlyOutflow - renterMonthlyOutflow;
      
      investmentPortfolio *= (1 + inputs.marketReturn / 100 / 12);

      if (difference > 0) {
         investmentPortfolio += difference;
         totalInvestedPrincipal += difference; 
      } else {
         investmentPortfolio += difference; 
      }

      if (investmentPortfolio <= 0) {
          investmentPortfolio = 0; 
          if (portfolioHitZeroMonth === null) portfolioHitZeroMonth = i;
      }

      if (i % 12 === 0) {
        currentMonthlyRent *= (1 + inputs.rentInflation / 100);
      }
    }

    const futurePropertyValue = inputs.propertyPrice * Math.pow(1 + inputs.propertyAppreciation / 100, inputs.analysisYears);
    const remainingLoanBalance = calculateRemainingBalance(loanAmount, inputs.mortgageInterest, inputs.mortgageTerm, totalMonths);
    const sellingExpenses = futurePropertyValue * (inputs.sellingExpensesRate / 100);
    
    let buyerSidePortfolio = remainingLiquidEquity * Math.pow(1 + inputs.marketReturn/100, inputs.analysisYears);
    const buyerSideGain = Math.max(0, buyerSidePortfolio - remainingLiquidEquity);
    const buyerSideTax = buyerSideGain * (inputs.capitalGainsTax / 100);
    buyerSidePortfolio -= buyerSideTax;

    const buyNetWorth = futurePropertyValue - remainingLoanBalance - sellingExpenses + buyerSidePortfolio;

    const portfolioGain = Math.max(0, investmentPortfolio - totalInvestedPrincipal);
    const capitalGainsTax = portfolioGain * (inputs.capitalGainsTax / 100);
    const rentNetWorth = investmentPortfolio - capitalGainsTax;

    const principalReduced = loanAmount - remainingLoanBalance;
    const totalInterestPaid = Math.max(0, totalMortgagePaid - principalReduced);
    const totalSunkBuy = totalInterestPaid + totalMaintenancePaid + purchaseTaxAmount + buyingMiscAmount + brokerageAmount + sellingExpenses;
    
    return {
        buyNetWorth,
        rentNetWorth,
        diffNetWorth: Math.abs(buyNetWorth - rentNetWorth),
        futurePropertyValue,
        remainingLoanBalance,
        loanAmount, 
        monthlyMortgage,
        totalSunkBuy,
        totalSunkRent: totalRentPaid,
        breakdownBuy: { interest: totalInterestPaid, maintenance: totalMaintenancePaid, purchaseTax: purchaseTaxAmount, buyingMisc: buyingMiscAmount, brokerage: brokerageAmount, sellingExpenses },
        breakdownRent: { rent: totalRentPaid },
        capitalGainsTax,
        portfolioHitZeroMonth,
        sellingExpenses,
        purchaseTaxAmount,
        buyingMiscAmount,
        brokerageAmount
    };
  }, [inputs, loanDetails]);

  // --- Handlers ---

  const handleInputChange = (key, value) => {
    setInputs(prev => ({ ...prev, [key]: value }));
  };

  // Mix Logic Handlers
  const handleTrackChange = (mixId, trackId, field, value) => {
      setUserMixes(prev => prev.map(mix => {
          if (mix.id !== mixId) return mix;
          const newTracks = mix.tracks.map(t => {
              if (t.id !== trackId) return t;
              return { ...t, [field]: value };
          });
          return { ...mix, tracks: newTracks };
      }));
  };

  // Specific handler for Amount changes to update Percent
  const handleTrackAmountChange = (mixId, trackId, amount) => {
      if (mixTabLoanAmount === 0) return;
      const newPercent = (amount / mixTabLoanAmount) * 100;
      handleTrackChange(mixId, trackId, 'percent', parseFloat(newPercent.toFixed(2)));
  };

  const addTrack = (mixId) => {
      setUserMixes(prev => prev.map(mix => {
          if (mix.id !== mixId) return mix;
          const newId = `t${Date.now()}`;
          // Pick color based on index
          const color = TRACK_COLORS[mix.tracks.length % TRACK_COLORS.length] || 'bg-gray-500';
          return {
              ...mix,
              tracks: [...mix.tracks, { id: newId, name: 'מסלול חדש', percent: 0, rate: 0, color }]
          };
      }));
  };

  const removeTrack = (mixId, trackId) => {
      setUserMixes(prev => prev.map(mix => {
          if (mix.id !== mixId) return mix;
          return { ...mix, tracks: mix.tracks.filter(t => t.id !== trackId) };
      }));
  };

  const normalizeMix = (mixId) => {
      setUserMixes(prev => prev.map(mix => {
          if (mix.id !== mixId) return mix;
          const total = mix.tracks.reduce((sum, t) => sum + t.percent, 0);
          if (total === 0) return mix;
          const newTracks = mix.tracks.map(t => ({
              ...t,
              percent: parseFloat(((t.percent / total) * 100).toFixed(1))
          }));
          return { ...mix, tracks: newTracks };
      }));
  };

  const syncMixData = () => {
      setIsMixCustomized(false);
      setMixTabLoanAmount(loanDetails.loanAmount);
      setMixTabTerm(inputs.mortgageTerm);
  };

  const resetMixTypes = () => {
      setUserMixes(DEFAULT_MIXES);
  };

  const applyMixToSimulator = () => {
      const totalCost = loanDetails.totalAcquisitionCost;
      const neededEquity = Math.max(0, totalCost - mixTabLoanAmount);
      setInputs(prev => ({
          ...prev,
          equity: neededEquity,
          mortgageTerm: mixTabTerm
      }));
      setIsMixCustomized(false);
      setActiveTab(2); 
  };

  const renderProgressBar = (val1, val2) => {
    const minVal = Math.min(val1, val2);
    let offset = 0;
    if (minVal < 0) offset = Math.abs(minVal) * 1.2; 

    const adjV1 = val1 + offset;
    const adjV2 = val2 + offset;
    const total = adjV1 + adjV2;

    if (total <= 0) return null;
    const p1 = (adjV1 / total) * 100;
    const p2 = (adjV2 / total) * 100;
    
    return (
      <div className="w-full h-4 bg-gray-200 rounded-full overflow-hidden flex mt-2">
        <div className="h-full bg-blue-500 transition-all duration-500" style={{ width: `${p1}%` }}></div>
        <div className="h-full bg-purple-500 transition-all duration-500" style={{ width: `${p2}%` }}></div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-50 text-gray-800 font-sans" dir="rtl">
      
      <header className="bg-white shadow-sm sticky top-0 z-20">
        <div className="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center space-x-2 space-x-reverse">
            <Building className="text-blue-600" size={28} />
            <div className="mr-2">
                <h1 className="text-xl font-bold text-gray-900 leading-none">היועץ הנדל"ני החכם</h1>
                <span className="text-xs text-gray-500">מהדורה מקצועית v10</span>
            </div>
          </div>
          <nav className="flex space-x-1 space-x-reverse bg-gray-100 p-1 rounded-lg">
            {[
              { id: 1, label: 'סימולטור', icon: Home },
              { id: 2, label: 'מינוף', icon: TrendingUp },
              { id: 3, label: 'תמהיל', icon: PieChart },
            ].map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`flex items-center px-3 py-2 rounded-md text-sm font-medium transition-colors ${
                  activeTab === tab.id
                    ? 'bg-white text-blue-600 shadow-sm'
                    : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                <tab.icon size={16} className="ml-2" />
                <span className="hidden sm:inline">{tab.label}</span>
              </button>
            ))}
          </nav>
        </div>
      </header>

      <main className="max-w-6xl mx-auto px-4 py-6 sm:py-8 pb-24">
        
        {/* --- TAB 1: SIMULATOR --- */}
        {activeTab === 1 && (
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-in fade-in duration-300">
            {/* Input Column */}
            <div className="lg:col-span-4 space-y-4">
               <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <h2 className="text-lg font-bold mb-4 flex items-center text-gray-800">
                        <Calculator className="ml-2 text-blue-500" size={20} /> נתוני עסקה
                    </h2>
                    
                    <InputField label="מחיר הנכס" value={inputs.propertyPrice} onChange={(v) => handleInputChange('propertyPrice', v)} suffix="₪" type="text" inputMode="numeric" />
                    <InputField label="הון עצמי קיים" value={inputs.equity} onChange={(v) => handleInputChange('equity', v)} suffix="₪" tooltip="סך הכסף הנזיל שיש ברשותכם כרגע" type="text" inputMode="numeric" />
                    <InputField label="שכירות נוכחית" value={inputs.currentRent} onChange={(v) => handleInputChange('currentRent', v)} suffix="₪" type="text" inputMode="numeric" />
                    
                    <div className="grid grid-cols-2 gap-2">
                        <InputField label="טווח בדיקה" value={inputs.analysisYears} onChange={(v) => handleInputChange('analysisYears', v)} type="number" suffix="שנים" inputMode="numeric" />
                        <InputField label="משך משכנתא" value={inputs.mortgageTerm} onChange={(v) => handleInputChange('mortgageTerm', v)} type="number" suffix="שנים" inputMode="numeric" />
                    </div>
               </div>

               <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <div className="flex justify-between items-center mb-4 cursor-pointer" onClick={() => setShowAdvanced(!showAdvanced)}>
                         <h2 className="text-lg font-bold flex items-center text-gray-800">
                            <Settings className="ml-2 text-gray-500" size={20} /> הנחות שוק
                        </h2>
                        <span className="text-xs text-blue-600 hover:underline">{showAdvanced ? 'הסתר מתקדם' : 'הצג מתקדם'}</span>
                    </div>

                    <div className="space-y-3">
                        <InputField label="תשואה שנתית בשוק ההון" value={inputs.marketReturn} onChange={(v) => handleInputChange('marketReturn', v)} suffix="%" type="text" inputMode="decimal" />
                        <InputField label="עליית ערך נכס שנתית" value={inputs.propertyAppreciation} onChange={(v) => handleInputChange('propertyAppreciation', v)} suffix="%" type="text" inputMode="decimal" />
                        <InputField label="ריבית משכנתא משוקללת" value={inputs.mortgageInterest} onChange={(v) => handleInputChange('mortgageInterest', v)} suffix="%" type="text" inputMode="decimal" />
                        
                        {showAdvanced && (
                            <div className="pt-3 border-t border-gray-100 mt-3 animate-in fade-in slide-in-from-top-2">
                                <h3 className="text-xs font-bold text-gray-500 uppercase mb-2">מיסוי ועלויות נלוות</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    <InputField label="אינפלציית שכירות" value={inputs.rentInflation} onChange={(v) => handleInputChange('rentInflation', v)} suffix="%" tooltip="בכמה עולה השכירות כל שנה?" type="text" inputMode="decimal" />
                                    <InputField label="עלות תחזוקה שנתית" value={inputs.maintenanceCost} onChange={(v) => handleInputChange('maintenanceCost', v)} suffix="%" tooltip="כאחוז מערך הנכס" type="text" inputMode="decimal" />
                                    <InputField label="מס רכישה (כניסה)" value={inputs.purchaseTaxRate} onChange={(v) => handleInputChange('purchaseTaxRate', v)} suffix="%" type="text" inputMode="decimal" />
                                    <InputField label="הוצאות עו''ד/שמאות" value={inputs.buyingMiscRate} onChange={(v) => handleInputChange('buyingMiscRate', v)} suffix="%" tooltip="עו''ד, אגרות, שמאות (בכניסה)" type="text" inputMode="decimal" />
                                    <InputField label="דמי תיווך (קנייה)" value={inputs.brokerageRate} onChange={(v) => handleInputChange('brokerageRate', v)} suffix="%" tooltip="הוצאה כוללת 17% מע''מ בחישוב" type="text" inputMode="decimal" />
                                    <InputField label="הוצאות מכירה/שבח" value={inputs.sellingExpensesRate} onChange={(v) => handleInputChange('sellingExpensesRate', v)} suffix="%" tooltip="עו''ד, תיווך ומס שבח במכירה עתידית" type="text" inputMode="decimal" />
                                    <InputField label="מס רווחי הון" value={inputs.capitalGainsTax} onChange={(v) => handleInputChange('capitalGainsTax', v)} suffix="%" type="text" inputMode="decimal" />
                                </div>
                            </div>
                        )}
                    </div>
               </div>
            </div>

            {/* Results Column */}
            <div className="lg:col-span-8 space-y-6">
              
              <div className="bg-gray-100 p-1 rounded-lg flex w-fit mx-auto lg:mx-0">
                  <button 
                    onClick={() => setViewMode('netWorth')}
                    className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${viewMode === 'netWorth' ? 'bg-white text-blue-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                  >
                      מאזן (שווי נקי)
                  </button>
                  <button 
                    onClick={() => setViewMode('cashFlow')}
                    className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${viewMode === 'cashFlow' ? 'bg-white text-blue-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                  >
                      תזרים (כסף אבוד)
                  </button>
              </div>

              {viewMode === 'netWorth' ? (
                <div className="animate-in fade-in zoom-in-95 duration-300">
                    <div className="bg-blue-50 border border-blue-100 p-4 rounded-xl mb-6">
                        <h2 className="text-xl font-bold text-blue-900 mb-1">כמה כסף יהיה לכם ביד בעוד {inputs.analysisYears} שנים?</h2>
                        <p className="text-sm text-blue-700 opacity-80">חישוב שווי נכסים בניכוי כל ההתחייבויות, המיסים וההוצאות (בהנחת מימוש מלא).</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <ResultCard 
                            title="מסלול קניה"
                            value={formatILS(results.buyNetWorth)}
                            subtext="שווי הנכס נטו (בניכוי חוב והוצאות מכירה)"
                            isWinner={results.buyNetWorth > results.rentNetWorth}
                            icon={Home}
                            bottomContent={
                                <div className="text-xs space-y-1 text-gray-500 pt-3 border-t">
                                    <div className="flex justify-between"><span>שווי נכס עתידי:</span> <span>{formatILS(results.futurePropertyValue)}</span></div>
                                    <div className="flex justify-between text-red-400"><span>יתרת משכנתא:</span> <span>-{formatILS(results.remainingLoanBalance)}</span></div>
                                    <div className="flex justify-between text-red-400"><span>הוצאות מכירה/שבח:</span> <span>-{formatILS(results.sellingExpenses)}</span></div>
                                </div>
                            }
                        />
                         <ResultCard 
                            title="מסלול שכירות"
                            value={formatILS(results.rentNetWorth)}
                            subtext="שווי תיק ההשקעות נטו (לאחר מס)"
                            isWinner={results.rentNetWorth > results.buyNetWorth}
                            icon={TrendingUp}
                            alertContent={results.portfolioHitZeroMonth ? `אזהרה: בחודש ${results.portfolioHitZeroMonth} תיק ההשקעות התרוקן. המודל מניח הזרמת הון חיצוני להמשך תשלום השכירות.` : null}
                            bottomContent={
                                <div className="text-xs space-y-1 text-gray-500 pt-3 border-t">
                                    <div className="flex justify-between"><span>סך התיק ברוטו:</span> <span>{formatILS(results.rentNetWorth + results.capitalGainsTax)}</span></div>
                                    <div className="flex justify-between text-red-400"><span>מס רווחי הון:</span> <span>-{formatILS(results.capitalGainsTax)}</span></div>
                                </div>
                            }
                        />
                    </div>
                </div>
              ) : (
                <div className="animate-in fade-in zoom-in-95 duration-300">
                    <div className="bg-orange-50 border border-orange-100 p-4 rounded-xl mb-6 flex justify-between items-center">
                        <div>
                            <h2 className="text-xl font-bold text-orange-900 mb-1">כמה כסף "נשרף" בדרך?</h2>
                            <p className="text-sm text-orange-700 opacity-80">עלויות ששולמו ולא חוזרות (ריבית, שכירות, בלאי, מיסים)</p>
                        </div>
                        <div className="text-right hidden sm:block">
                            <span className="block text-xs text-gray-500">למרות ההוצאות, נשאר ביד (Net Worth):</span>
                            <span className="font-bold text-gray-800">קניה: {formatILS(results.buyNetWorth)} | שכירות: {formatILS(results.rentNetWorth)}</span>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <ResultCard 
                            title="עלויות במסלול קניה"
                            headerColor="text-red-700"
                            value={formatILS(results.totalSunkBuy)}
                            subtext="סך הוצאות (ריבית, מיסים, תחזוקה)"
                            isWinner={results.totalSunkBuy < results.totalSunkRent}
                            icon={DollarSign}
                            bottomContent={
                                <div className="text-xs space-y-1 text-gray-500 pt-3 border-t">
                                    <div className="flex justify-between"><span>תשלומי ריבית:</span> <span>{formatILS(results.breakdownBuy.interest)}</span></div>
                                    <div className="flex justify-between"><span>תחזוקה ובלאי:</span> <span>{formatILS(results.breakdownBuy.maintenance)}</span></div>
                                    <div className="flex justify-between"><span>מס רכישה + נלוות (כניסה):</span> <span>{formatILS(results.breakdownBuy.purchaseTax + results.breakdownBuy.buyingMisc + results.breakdownBuy.brokerage)}</span></div>
                                    <div className="flex justify-between"><span>הוצאות יציאה:</span> <span>{formatILS(results.breakdownBuy.sellingExpenses)}</span></div>
                                </div>
                            }
                        />
                         <ResultCard 
                            title="עלויות במסלול שכירות"
                            headerColor="text-red-700"
                            value={formatILS(results.totalSunkRent)}
                            subtext="סך תשלומי השכירות"
                            isWinner={results.totalSunkRent < results.totalSunkBuy}
                            icon={DollarSign}
                            bottomContent={
                                <div className="text-xs space-y-1 text-gray-500 pt-3 border-t">
                                    <div className="flex justify-between"><span>שכירות מצטברת:</span> <span>{formatILS(results.breakdownRent.rent)}</span></div>
                                </div>
                            }
                        />
                    </div>
                </div>
              )}

              <div className="bg-white p-6 rounded-xl shadow-sm mt-4">
                <h3 className="font-bold mb-4 text-center text-gray-700">הפער הכלכלי (Net Worth Gap)</h3>
                <div className="flex justify-between text-sm mb-1 font-mono">
                    <span className="text-blue-600 font-bold">{formatILS(results.buyNetWorth)}</span>
                    <span className="text-purple-600 font-bold">{formatILS(results.rentNetWorth)}</span>
                </div>
                {renderProgressBar(results.buyNetWorth, results.rentNetWorth)}
                <p className="mt-4 text-center font-medium text-gray-700">
                    ההפרש לטובת {results.buyNetWorth > results.rentNetWorth ? 'הקניה' : 'השכירות'}: 
                    <span className="text-xl mr-2 font-bold text-green-600">{formatILS(results.diffNetWorth)}</span>
                </p>
              </div>

               <div className="flex justify-end mt-4">
                   <button onClick={() => setActiveTab(2)} className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 flex items-center transition-colors shadow-lg">
                       שלב הבא: אופטימיזציית הון עצמי <ArrowRightLeft className="mr-2" size={18} />
                   </button>
               </div>
            </div>
          </div>
        )}

        {/* --- TAB 2: EQUITY --- */}
        {activeTab === 2 && (
          <div className="max-w-3xl mx-auto space-y-6 animate-in slide-in-from-right-4 duration-500">
             <div className="bg-white p-8 rounded-xl shadow-sm text-center">
              <h2 className="text-2xl font-bold mb-2">כמה הון עצמי להביא?</h2>
              <p className="text-gray-500 mb-8">האם להשתמש בכל החסכונות או לקחת משכנתא גדולה יותר ולהשאיר כסף נזיל להשקעות?</p>

              {(results.purchaseTaxAmount + results.buyingMiscAmount + results.brokerageAmount) > 0 && (
                  <div className="bg-red-50 text-red-700 p-3 rounded-lg text-sm mb-6 inline-block mx-auto border border-red-100">
                      שים לב: <strong>{formatILS(results.purchaseTaxAmount + results.buyingMiscAmount + results.brokerageAmount)}</strong> מההון העצמי הולכים להוצאות רכישה (מס, עו"ד, תיווך וכו').
                  </div>
              )}

              <div className="mb-10 px-4">
                <label className="block text-lg font-medium mb-4">
                  LTV (מימון משווי נכס): <span className="text-blue-600 font-bold text-2xl">{Math.round((loanDetails.loanUsedForProperty / inputs.propertyPrice) * 100)}%</span>
                </label>
                <input 
                  type="range" 
                  min="25" 
                  max="75" 
                  step="5"
                  value={Math.round((loanDetails.loanUsedForProperty / inputs.propertyPrice) * 100) || 70}
                  onChange={(e) => {
                    const percent = parseInt(e.target.value);
                    const targetLoanForProp = inputs.propertyPrice * (percent / 100);
                    
                    const targetEquityForProp = inputs.propertyPrice - targetLoanForProp;
                    
                    const purchaseTaxAmount = inputs.propertyPrice * (inputs.purchaseTaxRate / 100);
                    const buyingMiscAmount = inputs.propertyPrice * (inputs.buyingMiscRate / 100);
                    const brokerageAmount = inputs.propertyPrice * (inputs.brokerageRate / 100) * (1 + inputs.vatRate / 100);
                    
                    const targetEquityUsed = targetEquityForProp + purchaseTaxAmount + buyingMiscAmount + brokerageAmount;
                    
                    handleInputChange('equity', Math.max(0, targetEquityUsed));
                  }}
                  className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                />
                <div className="flex justify-between text-sm text-gray-500 mt-2">
                  <span>25% (הון גבוה)</span>
                  <span>75% (מינוף מקסימלי)</span>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-right">
                <div className="bg-blue-50 p-4 rounded-lg">
                  <div className="text-gray-500 text-sm mb-1">סכום משכנתא כולל</div>
                  <div className="text-xl font-bold text-blue-900">{formatILS(results.loanAmount)}</div>
                  <div className="text-xs text-gray-400 mt-1">LTC: {Math.round((results.loanAmount / loanDetails.totalAcquisitionCost)*100)}% (מהעלות הכוללת)</div>
                </div>
                <div className="bg-green-50 p-4 rounded-lg">
                  <div className="text-gray-500 text-sm mb-1">החזר חודשי (התחלתי)</div>
                  <div className="text-xl font-bold text-green-900">{formatILS(results.monthlyMortgage)}</div>
                  <div className="text-xs text-green-700 mt-1">לפי ריבית ממוצעת: {inputs.mortgageInterest}%</div>
                </div>
                <div className="bg-purple-50 p-4 rounded-lg">
                  <div className="text-gray-500 text-sm mb-1">הון עצמי נדרש (כולל הוצאות)</div>
                  <div className="text-xl font-bold text-purple-900">{formatILS(inputs.equity)}</div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* --- TAB 3: MIX --- */}
        {activeTab === 3 && (
            <div className="space-y-6 animate-in slide-in-from-right-4 duration-500">
                 <div className="bg-blue-900 text-white p-6 rounded-xl shadow-lg relative overflow-hidden flex flex-col justify-between items-start">
                    <div className="relative z-10 w-full flex justify-between items-start">
                        <div>
                            <h2 className="text-2xl font-bold mb-2">בניית תמהיל והתאמה להצעות בנק</h2>
                            <p className="opacity-80 text-sm mb-4">מסך זה הוא "ארגז חול" עצמאי לבדיקת משכנתאות.</p>
                        </div>
                        <div className="flex items-center space-x-2 space-x-reverse relative z-10">
                            {isMixCustomized ? (
                                <button onClick={applyMixToSimulator} className="text-blue-900 text-xs sm:text-[10px] font-bold hover:bg-blue-100 flex items-center bg-white px-3 py-1 rounded-full shadow-lg animate-pulse">
                                    <Save size={12} className="ml-1" /> עדכן סימולטור
                                </button>
                            ) : null}
                            <button onClick={syncMixData} className="text-sm sm:text-xs px-4 sm:px-3 py-2 sm:py-1 opacity-90 hover:opacity-100 flex items-center bg-blue-800 rounded-full border border-blue-700">
                                <Link size={12} className="ml-1" /> סנכרן נתונים
                            </button>
                            <button onClick={resetMixTypes} className="text-sm sm:text-xs px-4 sm:px-3 py-2 sm:py-1 opacity-90 hover:opacity-100 flex items-center bg-blue-800 rounded-full border border-blue-700">
                                <RotateCcw size={12} className="ml-1" /> איפוס תמהילים
                            </button>
                        </div>
                    </div>

                    <div className="relative z-10 w-full bg-blue-800/50 p-4 rounded-lg border border-blue-700/50 flex flex-wrap gap-4 items-end">
                        <div className="w-40">
                            <label className="text-xs text-blue-200 block mb-1">סכום המשכנתא</label>
                            <input 
                                type="text"
                                inputMode="numeric"
                                value={Number(mixTabLoanAmount).toLocaleString()} 
                                onChange={(e) => {
                                    const val = parseFloat(e.target.value.replace(/,/g, '')) || 0;
                                    setMixTabLoanAmount(val);
                                    setIsMixCustomized(true);
                                }}
                                className="w-full bg-blue-900/50 border border-blue-600 text-white rounded px-2 py-1 focus:outline-none focus:border-blue-400"
                            />
                        </div>
                        <div className="w-24">
                            <label className="text-xs text-blue-200 block mb-1">שנים</label>
                            <input 
                                type="number"
                                inputMode="numeric"
                                value={mixTabTerm} 
                                onChange={(e) => {
                                    setMixTabTerm(parseFloat(e.target.value) || 0);
                                    setIsMixCustomized(true);
                                }}
                                className="w-full bg-blue-900/50 border border-blue-600 text-white rounded px-2 py-1 focus:outline-none focus:border-blue-400"
                            />
                        </div>
                        {isMixCustomized && (
                            <div className="text-xs text-yellow-300 pb-2 flex items-center">
                                <AlertTriangle size={12} className="ml-1" /> מצב עריכה ידני
                            </div>
                        )}
                    </div>
                    
                    <PieChart className="absolute left-[-20px] top-[-20px] text-blue-800 opacity-20" size={150} />
                </div>

                <div className="grid grid-cols-1 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {userMixes.map((mix) => {
                        const loan = mixTabLoanAmount;
                        const term = mixTabTerm;
                        
                        let totalPayment = 0;
                        let weightedInterest = 0;
                        let totalPercent = 0;

                        const trackElements = mix.tracks.map(track => {
                            const pmt = calculatePMT(loan * (track.percent/100), track.rate, term);
                            totalPayment += pmt;
                            totalPercent += track.percent;
                            weightedInterest += (track.percent * track.rate);
                            // Calculated Amount for display
                            const amount = (loan * track.percent) / 100;
                            return { ...track, pmt, amount };
                        });

                        weightedInterest = totalPercent > 0 ? weightedInterest / totalPercent : 0;
                        totalPercent = Math.round(totalPercent * 10) / 10;
                        const isInvalid = Math.abs(totalPercent - 100) > 0.1;

                        return (
                            <div key={mix.id} className={`bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-shadow border-2 flex flex-col ${isInvalid ? 'border-red-300' : 'border-gray-100'}`}>
                                <div className="p-4 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
                                    <h3 className="font-bold text-lg text-gray-800">{mix.name}</h3>
                                    {isInvalid ? (
                                        <button onClick={() => normalizeMix(mix.id)} className="text-xs px-2 py-1 rounded-full bg-red-100 text-red-600 font-bold flex items-center hover:bg-red-200 transition-colors">
                                            <RefreshCcw size={12} className="ml-1"/> נרמל {totalPercent}%
                                        </button>
                                    ) : (
                                        <span className={`text-xs px-2 py-1 rounded-full flex items-center ${
                                            mix.risk === 'נמוך' ? 'bg-green-100 text-green-700' :
                                            mix.risk === 'בינוני' ? 'bg-yellow-100 text-yellow-700' :
                                            'bg-red-100 text-red-700'
                                        }`}>
                                            <Edit3 size={10} className="ml-1 opacity-50"/>
                                            סיכון {mix.risk}
                                        </span>
                                    )}
                                </div>
                                
                                <div className="p-4 space-y-4 flex-grow">
                                    <p className="text-sm text-gray-500 mb-2">{mix.desc}</p>
                                    
                                    <div className="space-y-3 mt-4">
                                        {trackElements.map((track) => (
                                            <div key={track.id} className={`p-3 rounded-xl border border-gray-100/50 ${track.color.replace('bg-', 'bg-opacity-5 bg-')}`}>
                                                <div className="flex justify-between items-center mb-2">
                                                    <div className="flex items-center">
                                                        <span className={`w-2.5 h-2.5 rounded-full ${track.color} ml-2 shadow-sm`}></span>
                                                        <input 
                                                            type="text" 
                                                            value={track.name}
                                                            onChange={(e) => handleTrackChange(mix.id, track.id, 'name', e.target.value)}
                                                            className="font-bold text-gray-700 bg-transparent outline-none w-32 text-sm focus:border-b focus:border-blue-300 transition-all px-1"
                                                        />
                                                    </div>
                                                    <button onClick={() => removeTrack(mix.id, track.id)} className="text-gray-300 hover:text-red-500 transition-colors p-1">
                                                        <Trash2 size={14} />
                                                    </button>
                                                </div>
                                                
                                                <div className="flex space-x-2 space-x-reverse">
                                                     <div className="flex-1">
                                                        <MiniInput label="ריבית" value={track.rate} suffix="%" className="w-full" onChange={(v) => handleTrackChange(mix.id, track.id, 'rate', v)} />
                                                     </div>
                                                     <div className="flex-1">
                                                        <MiniInput label="% תמהיל" value={track.percent} suffix="%" className="w-full" onChange={(v) => handleTrackChange(mix.id, track.id, 'percent', v)} />
                                                     </div>
                                                     <div className="flex-[1.5]">
                                                        <MiniInput label="סכום" value={Math.round(track.amount)} suffix="₪" className="w-full" onChange={(v) => handleTrackAmountChange(mix.id, track.id, v)} />
                                                     </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={() => addTrack(mix.id)} className="w-full py-2 border-2 border-dashed border-gray-200 rounded-lg text-gray-400 hover:border-blue-300 hover:text-blue-500 text-sm flex items-center justify-center transition-colors">
                                        <Plus size={16} className="ml-1"/> הוסף מסלול
                                    </button>
                                </div>

                                <div className="p-4 border-t border-gray-100 bg-gray-50">
                                    <div className="text-center">
                                        <div className="text-gray-500 text-xs mb-1">החזר חודשי התחלתי</div>
                                        <div className={`text-2xl font-bold ${isInvalid ? 'text-gray-400' : 'text-blue-600'}`}>
                                            {isInvalid ? '---' : formatILS(totalPayment)}
                                        </div>
                                        {isInvalid ? (
                                            <div className="text-xs text-red-500 mt-1">אחוזים לא תקינים</div>
                                        ) : (
                                            <div className="text-xs text-gray-500 mt-2">
                                                ריבית משוקללת: <span className="font-bold text-gray-700">{weightedInterest.toFixed(2)}%</span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
        )}
      </main>
    </div>
  );
}